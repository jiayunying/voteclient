<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
	<title>《临床药学与治疗学》H5投票系统</title>
	<link rel="stylesheet" href="./css/swiper.min.css">
	<link rel="stylesheet" href="./css/animate.min.css">
	<link rel="stylesheet" href="./css/style.css">

	<script src="./js/swiper.min.js"></script>
	<script src="./js/jquery-1.7.2.js"></script>
	<script src="./js/rem.js"></script>
	<script src="./js/swiper.animate.min.js"></script>
	<script src="./js/jquery.touchSwipe.min.js"></script>
	<script src="./js/main.js"></script>
	<script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js" type="text/javascript"></script>
	<style>
		body{
			background: url( ./images/basemap.png ) no-repeat center bottom; background-size: 100%
		}
	</style>
</head>
<body>
	<div class="swiper-container hides">
		<div class="swiper-wrapper">
			<div class="swiper-slide">
				<div class="boxone">
                    <div class="one_top ys ani resize" style="top:5%;" swiper-animate-effect="bounceInDown" swiper-animate-duration="1s" swiper-animate-delay="0s">
                        <img class="icon_left" src="./images/icon_left.png" alt="">
                        <img class="icon_right" src="./images/icon_right.png" alt="">
                    </div>
                    <div class="ys ani resize" style="top:80%;" swiper-animate-effect="bounceInLeft" swiper-animate-duration="0.5s" swiper-animate-delay="1s" >
						<h2 class="title">《临床药理学与治疗学》中文版</h2>
					</div>
					<div class="ys ani resize" style="bottom:30%;" swiper-animate-effect="bounceInRight" swiper-animate-duration="0.5s" swiper-animate-delay="1s" >
						<div class="one_bton">
							<p>诚邀您</p>
							<span>进入选文环节</span>
						</div>
					</div>
                </div>
			</div>
			<div class="swiper-slide">
				<div class="boxone">
                    <div class="one_top ys ani resize" swiper-animate-effect="bounceInDown" swiper-animate-duration="1s" swiper-animate-delay="0s">
                        <img class="icon_left" src="./images/icon_left.png" alt="">
                        <img class="icon_right" src="./images/icon_right.png" alt="">
                    </div>
                    <div class="ys ani resize" style="top:50%;" swiper-animate-effect="fadeIn" swiper-animate-duration="0.5s" swiper-animate-delay="1s" >
						<h2 class="title">《临床药理学与治疗学》中文版</h2>
					</div>
					<div class="ys ani resize" style="top:80%;" swiper-animate-effect="fadeIn" swiper-animate-duration="1s" swiper-animate-delay="1.5s" >
						<div class="one_text">
							<h2>尊敬的教授，您好！</h2>
						</div>
					</div>
					<div class="ys ani resize" style="top:100%;" swiper-animate-effect="fadeIn" swiper-animate-duration="1.5s" swiper-animate-delay="2s" >
						<div class="one_text">
							<h3>第3期中文版备选文献是根据中文版主编胡欣教授确定的3个主题整理，请您浏览备选文献摘要，并从中初选15篇文献。最终入选文章将依据个篇文章的初选得票情况确定</h3>
							<h4> ● 第三期中文版主题及内容来源：</h4>
							<div>
								<p>-Drug - Drug Interactions</p >
								<p>(原刊Volume 105,Issue 6,编号1-22文献)</p >
								<p>-Real - World Data:Real -World Evidence</p >
								<p>(原刊Volume 106,Issue 1,编号23-52文献)</p >
								<p>Pharmacogenetics Pharmacogenomics</p >
								<p>(原刊Volume 106,Issue 2,编号53-69文献)</p >
							</div>
							<h4> ● 投票截止日期为12月20日，之后将不计入统计</h4>
							<h4> ● 每位编委只能投15篇文章</h4>
							<h4> ● 中文标题仅供参考</h4>
						</div>
					</div>
					<div class="ys ani content_text" style="bottom:30%;" swiper-animate-effect="fadeIn" swiper-animate-duration="2s" swiper-animate-delay="2.2s" >
						<div class="one_text one_for">
							<p>CPT中文版</p>
							<p>SSS出版公司</p>
							<p>恶趣味群（中国）</p>
						</div>
					</div>
                </div>
			</div>
			<div class="swiper-slide">   
				<div class="boxone boxthree">
					<div class="one_top ys ani resize" style="top:5%;" swiper-animate-effect="bounceInDown" swiper-animate-duration="1s" swiper-animate-delay="0s">
                        <img class="icon_left" src="./images/icon_left.png" alt="">
                        <img class="icon_right" src="./images/icon_right.png" alt="">
                    </div>
                    <!-- <div class="hides"> -->
                    	<div class="priority">
		                    <div class="ys ani resize" style="top:35%;">
								<h2 class="title">《临床药理学与治疗学》中文版</h2>
								<h3 class="title"> — 入选文章 — </h3>
							</div>
						</div>
						<div class="three_text pri_three">
						</div>
                    <!-- </div> -->
                </div>   
			</div>
			<div class="swiper-slide">
				<div class="boxone boxthree">
					<div class="one_top ys ani resize" style="top:5%;" swiper-animate-effect="bounceInDown" swiper-animate-duration="1s" swiper-animate-delay="0s">
                        <img class="icon_left" src="./images/icon_left.png" alt="">
                        <img class="icon_right" src="./images/icon_right.png" alt="">
                    </div>
                	<div class="priority">
	                    <div class="ys ani resize" style="top:35%;">
							<h2 class="title">《临床药理学与治疗学》中文版</h2>
							<h3 class="title"> — 入选文章 — </h3>
						</div>
					</div>
					<div class="three_text pri_four">
						
					</div>
                </div>         
			</div>
		</div>
	 	<img src="./images/arrow.png" style="width:20px;height:15px; top:460px; left:150px;" id="array" class="resize"> 
		<div class="swiper-pagination"></div>

		<aside class="audio-bg">
        	<i id="audio_btn" class="on"></i>
        </aside>
        <audio style="display:none; height: 0" id="myAudio" autoplay preload="auto" src="./audio/audio.mp3" loop></audio>
	</div>
	<div class="vote">
		<div class="layer_top">
	        <img class="icon_left" src="./images/icon_left.png" alt="">
	        <img class="icon_right" src="./images/icon_right.png" alt="">
	    </div>
    	<div class="vote_layer">
    		<img class="closebtn" src="./images/Close.png" alt="">
			<div class="text_two">
				<div>
					<span><img src="./images/titlelogo.png" alt=""></span>
					<p>eqweqwewqeeqweqweqweqweqweqweeqweqweeqweqwewqeeqweqweqweqweqweqweeqweqweeqweqweqweqweqweeqweqwe</p>
				</div>
				<p class="s_p1">的我翁热翁二所多多撒所多撒多撒多撒大所大所做多的我翁热翁二所多多撒所多撒多撒多撒大所大所做多</p>
				<p class="s_p1 s_lar">dsaasdasdasfgewdsfdsfdfsdadsfsfasdsadfsdkdjaskljfdskjfksdjkjfdskfjskdjkas</p>
			</div>
			<button class="btn_vote">投票</button>
    	</div>
    </div>



<script>

	var appid = '';
	if ( window.location.host == "www.medcircle.cn") {
		appid = "wx65bd7b08d1a47153"; //生产
	} else {
		appid = "wxc94beeaf4f4c9d5e"; //测试
	}

	var code = GetQueryString('code');
	var callback = 'http://www.medcircle.cn/voteclient/index.html';
	var redirect_uri = window.location.origin + window.location.pathname;
	var wx_link = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' + appid + '&redirect_uri=' +
	redirect_uri + '&response_type=code&scope=snsapi_userinfo&state=1' + '#' + 'wechat_redirect';

	var userinfo = JSON.parse(localStorage.getItem("openid"));
	if ( userinfo == '' ) {
		alert( wx_link )
		if(code==null){
			window.location.href = wx_link;
			code = GetQueryString('code');
		}else{
			alert( code )
			$.ajax({
			    type : "POST",
			    dataType : "json",
			    url : "http://www.medcircle.cn/voteapp/wechatlogin",
			    xhrFields:{
					withCredentials:true
				},
			    data : {
			    	code : code
			    },
				success: function( res ){
					localStorage.setItem("openid", res.data.openid);
					window.location.href="http://www.medcircle.cn/voteclient/index.html"
					initialization();
				 //    if( res.status == 200 ){
					// 	window.location.href="http://www.medcircle.cn/voteclient/index.html"
					// 	initialization();
					// }else{
					// 	console.log(res)
					// 	return false;
					// }
				},
				error: function( msg ){
					alert('服务器发生错误！');
				}
			});
		}
	};


	function GetQueryString(name){
		var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
		var r = window.location.search.substr(1).match(reg);
		if(r!=null)return unescape(r[2]); return null;

	}
</script>
<script>
	scaleW=window.innerWidth/320;
	scaleH=window.innerHeight/480;
	var resizes = document.querySelectorAll('.resize');
	for (var j=0; j<resizes.length; j++) {
		resizes[j].style.width=parseInt(resizes[j].style.width)*scaleW+'px';
		resizes[j].style.height=parseInt(resizes[j].style.height)*scaleH+'px';
		resizes[j].style.top=parseInt(resizes[j].style.top)*scaleH+'px';
		resizes[j].style.left=parseInt(resizes[j].style.left)*scaleW+'px'; 
	}
			
	var mySwiper = new Swiper ('.swiper-container', {
		direction : 'vertical',
		pagination: '.swiper-pagination',
		noSwipingClass : 'three_text',
		//virtualTranslate : true,
		// mousewheelControl : true,			// 鼠标滚轮滚屏
		onInit: function(swiper){
			swiperAnimateCache(swiper);
			swiperAnimate(swiper);
		},
		onSlideChangeEnd: function(swiper){
			swiperAnimate(swiper);
		},
		onTransitionEnd: function(swiper){
			swiperAnimate(swiper);
		},
		watchSlidesProgress: true,
		onProgress: function(swiper){
			for (var i = 0; i < swiper.slides.length; i++){
				var slide = swiper.slides[i];
				var progress = slide.progress;
				var translate = progress*swiper.height/4;  
				scale = 1 - Math.min(Math.abs(progress * 0.5), 1);
				var opacity = 1 - Math.min(Math.abs(progress/2),0.5);
				slide.style.opacity = opacity;
				es = slide.style;
				es.webkitTransform = es.MsTransform = es.msTransform = es.MozTransform = es.OTransform = es.transform = 'translate3d(0,'+translate+'px,-'+translate+'px) scaleY(' + scale + ')';
			}
		},
		onSetTransition: function(swiper, speed) {
			for (var i = 0; i < swiper.slides.length; i++){
				es = swiper.slides[i].style;
				es.webkitTransitionDuration = es.MsTransitionDuration = es.msTransitionDuration = es.MozTransitionDuration = es.OTransitionDuration = es.transitionDuration = speed + 'ms';
			}
		},
	});

	function music(){
		var m = document.getElementById("myAudio");
		console.log( m.paused )
		if( m.paused ){
			m.play();
		}
		$("#audio_btn").click(function(e){
			e.stopPropagation();
			togglePlay($(e.target));
		});
	};
	music();
		
	$(function(){
		var phaseid = '';
		var closedate = '';
		$('.vote').hide();
	})
	

	function initialization(){				// 初始化
		$.ajax({
		    type : "GET",
		    dataType : "json",
		    url : "http://www.medcircle.cn/voteapp/phaseconfig",
		    data : {},
			success: function( data ){
				var data = data.data;
				phaseid = data[0].id;
				closedate = data[0].closedate;
				Votinglist();
				Displaylist();
			},
			error: function( msg ){
			
			}
		});
	};
	function Votinglist(){			// 投票列表
		
		$('.hides').show();
		$.ajax({
		    type : "GET",
		    dataType : "json",
		    url : "http://www.medcircle.cn/voteapp/paperlist",
		    data : {
		    	flag : '1',
		    	phaseid : phaseid
		    },
			success: function( data ){
				var data = data.data;

			    var str = '';
			    for ( var i = 0; i < data.length; i++ ) {
			    	if ( data[i].p_title_en == null ) {
			    		data[i].p_title_en = '';
			    	};
			    	str += '<div class="text_two">'
								+ '<div>'
									+ '<span><img src="./images/titlelogo.png" alt=""></span>'
									+ '<p>' + data[i].p_title_en + '</p>'
								+ '</div>'
								+ '<p class="s_p1">' + data[i].p_title + '</p>'
								+ '<p class="p1 bet_bor ps"></p>'
							+ '</div>'
			    };
			    $('.pri_three').html( str )
			    $('.text_two').on('click', function(){
					$('.hides').hide();
					$('.vote').show();
					var current = data[$(this).index()];
					var details = '';
					if ( current.p_title_en == null ) {
						current.p_title_en = '';
					};
					if ( current.p_title == null ) {
						current.p_title = '';
					};
					if ( current.p_summary == null ) {
						current.p_summary = '';
					};
					details += '<img class="closebtn" src="./images/Close.png" alt="">'
									+ '<div class="text_two">'
										+ '<div>'
											+ '<span><img src="./images/titlelogo.png" alt=""></span>'
											+ '<p>' + current.p_title_en + '</p>'
										+ '</div>'
										+ '<p class="s_p1">' + current.p_title + '</p>'
										+ '<p class="s_p1 s_lar">' + current.p_summary + '</p>'
									+ '</div>'
									+ '<button class="btn_vote">投票</button>';
					$('.vote_layer').html( details );

					$('.closebtn').on('click',function(){
						$('.vote').hide();
						$('.hides').show();
					})

					$('.btn_vote').click( function(){
						$.ajax({
						    type : "GET",
						    dataType : "json",
						    url : "http://www.medcircle.cn/voteapp/vote",
						    data : {
						    	phaseid : phaseid,
						    	paperid : current.p_id,
						    	userid : '1'
						    },
							success: function( data ){
							    console.log( data )
							    if ( data.code == 0 ) {
							    	alert( '投票成功' );
							    } else if ( data.code == 1001 ) {
							    	alert( '该用户已经对此文章投过票' );
							    };
							},
							error: function( msg ){
								
							}
						});
					})
				})
			},
			error: function( msg ){
			
			}
		});
	};
	function Displaylist(){
		$.ajax({
		    type : "GET",
		    dataType : "json",
		    url : "http://www.medcircle.cn/voteapp/paperlist",
		    data : {
		    	flag : '2',
		    	phaseid : phaseid
		    },
			success: function( data ){
				var data = data.data;
			    var str = '';
			    for ( var i = 0; i < data.length; i++ ) {
			    	if ( data[i].p_title_en == null ) {
			    		data[i].p_title_en = '';
			    	};
			    	str += '<div class="text_s">'
								+ '<div class="text_s_div">'
									+ '<span><img src="./images/titlelogo.png" alt=""></span>'
									+ '<p class="p1 pcolor">' + data[i].p_title_en + '</p>'
									+ '<p class="p2">' + data[i].COUNT + ' 票</p>'
								+ '</div>'
								+ '<div class="text_s_div">'
									+ '<p class="p1 ps">' + data[i].p_title + '</p>'
								+ '</div>'
								+ '<div class="text_s_div">'
									+ '<p class="bot_bor ps"></p>'
								+ '</div>'
							+ '</div>'
			    };
			    $('.pri_four').html( str )
			},
			error: function( msg ){
			
			}
		});
	};
	document.addEventListener('DOMContentLoaded',function (){		// 解决自动播放问题
	    function audioAutoPlay(){
	        var audio_ = document.getElementById('myAudio');
	            audio_.play();
	        document.addEventListener("WeixinJSBridgeReady", function () {
	                audio_.play();
	        }, false);
	    }
	    audioAutoPlay();
	});
</script>


</body>
</html>
